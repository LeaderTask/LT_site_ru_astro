---
import { Image } from 'astro:assets';
import FeaturesAccordionItem from './FeaturesAccordionItem.astro';
import GradientTextElem from '@/shared/ui/GradientTextElem/GradientTextElem.astro';
import { getImageDimensions } from '@/shared';

export interface FeatureItem {
	icon: any;
	title: string;
	description: string;
	image: string;
	customClass?: string;
	justifyClass?: string;
}

interface Props {
	items: FeatureItem[];
	reverse?: boolean;
	title: string;
	gradientText?: string;
}

const { items, reverse = false, title, gradientText } = Astro.props;
const accordionId = `features-accordion-${Math.random().toString(36).substr(2, 9)}`;

const imagesDimensions = await Promise.all(
	items.map(async (item: FeatureItem) => ({
		image: item.image,
		dimensions: item.image.startsWith('/') ? await getImageDimensions(item.image) : { width: 800, height: 600 },
	}))
);
const getImageDim = (imagePath: string) =>
	imagesDimensions.find((img: { image: string; dimensions: { width: number; height: number } }) => img.image === imagePath)
		?.dimensions || { width: 800, height: 600 };
---

<section
	class="py-15 md:py-20 xl:py-30 select-none"
	data-features-accordion
	data-accordion-id={accordionId}
	data-accordion-reverse={reverse ? 'true' : 'false'}
>
	<h1
		class="text-[24px] md:text-[32px] lg:text-[38px] xl:text-[44px] leading-8 md:leading-13 lg:leading-15 xl:leading-15 max-w-225 font-bold text-primary text-center mx-auto mb-6 md:mb-12 xl:mb-15"
	>
		{title}
		<br class="lg:hidden" />
		<GradientTextElem>{gradientText}</GradientTextElem>
	</h1>
	<div
		id={`${accordionId}-desktop`}
		class="hidden xl:flex flex-col xl:flex-row justify-center items-center xl:items-start gap-8 max-w-328 mx-auto"
		data-reverse={reverse}
	>
		<div class="flex-1 flex flex-col gap-6 max-w-160">
			{
				items.map((item: FeatureItem, index: number) => (
					<FeaturesAccordionItem
						icon={item.icon}
						title={item.title}
						description={item.description}
						isActive={index === 0}
						dataIndex={index}
						accordionId={accordionId}
					/>
				))
			}
		</div>
		<div class="flex-1 flex items-center justify-center h-full">
			<div
				id={`${accordionId}-image-container`}
				class="relative w-full lg:min-h-117 max-w-160 rounded-5 bg-orange-light overflow-hidden shadow-card pt-8"
			>
				{
					items.map((item: FeatureItem, index: number) => (
						<div
							id={`${accordionId}-image-${index}`}
							class={`absolute inset-0 flex justify-end items-end w-full transition-opacity duration-500 ${item.justifyClass || 'pl-13'}`}
							style={`opacity: ${index === 0 ? '1' : '0'}; pointer-events: ${index === 0 ? 'auto' : 'none'};`}
							data-image-index={index}
						>
							<Image
								src={item.image}
								alt={item.title}
								width={getImageDim(item.image).width}
								height={getImageDim(item.image).height}
								class={`w-full h-auto object-cover ${item.customClass || ''}`}
								loading={index === 0 ? 'eager' : 'lazy'}
							/>
						</div>
					))
				}
			</div>
		</div>
	</div>
	<div
		id={`${accordionId}-mobile`}
		class="flex flex-col items-center gap-6 max-w-160 mx-auto xl:hidden"
	>
		{
			items.map((item: FeatureItem) => (
				<div class="w-full flex flex-col gap-4 bg-white rounded-5 md:rounded-6 overflow-hidden">
					<div class="p-4 md:p-5 pb-0">
						<div class="flex items-start gap-2">
							<svg class="w-7 h-7 shrink-0">
								<use href={`/icons/all-icons.svg#${item.icon}`} />
							</svg>
							<div class="flex flex-col gap-2">
								<h4 class="text-[18px] md:text-[22px] lg:text-[24px] leading-6 md:leading-8 lg:leading-10 font-bold text-primary">
									{item.title}
								</h4>
								<p class="text-[16px] md:text-[18px] lg:text-[20px] leading-6 md:leading-8 lg:leading-10 text-secondary">
									{item.description}
								</p>
							</div>
						</div>
					</div>
					<div class="flex-1 flex items-center justify-center">
						<div
							class={`flex justify-end items-end w-full max-h-61.25 rounded-5 md:rounded-6 bg-orange-light overflow-hidden shadow-card pt-8 ${item.justifyClass || 'pl-13'}`}
						>
							<Image
								src={item.image}
								alt={item.title}
								width={getImageDim(item.image).width}
								height={getImageDim(item.image).height}
								class={`w-full h-auto object-cover ${item.customClass || ''}`}
							/>
						</div>
					</div>
				</div>
			))
		}
	</div>
</section>
